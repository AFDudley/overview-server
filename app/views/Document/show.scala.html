@(document: core.Document)(implicit lang: Lang)

@defining(scopedMessages("views.Document.show")) { m =>
  <html>
    <head>
      <title data-m-loading="@m("loading")">@m("loading")</title>
      <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/main.css")" />
      <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/DV.css")" />
      <style type="text/css">
        html, body {
          width: 100%;
          height: 100%;
          border: none;
          margin: 0;
          padding: 0;
          position: relative;
        }

        h3 {
          font-height: 16px;
          line-height: 20px;
          padding: 10px;
          margin: 0;
          white-space: nowrap;
        }

        ul.actions {
          position: absolute;
          line-height: 20px;
          top: 0;
          right: 0;
          margin: 10px;
          padding: 0;
          list-style: none;
          background: white;
        }

        li {
          display: inline;
        }

        div.container {
          position: absolute;
          top: 40px;
          bottom: 0;
          width: 100%;
        }

        iframe {
          margin: 0;
          padding: 0;
          border: none;
          height: 100%;
          width: 100%;
        }
      </style>
    </head>
    <body>
      <h3 data-m-loading="@m("loading")" style="display:none;">@m("loading")</h3>
      <ul class="actions">
        <li><a href="#" class="toggle-sidebar" data-m-enable="@m("sidebar.enable")" data-m-disable="@m("sidebar.disable")" style="display:none;"></a></li>
      </ul>
      <div class="container"><iframe src=""></iframe></div>

      <script type="text/javascript" src="@routes.Assets.at("javascripts/vendor/jquery-1-8-1.js")"></script>

      <script type="text/javascript">
        var default_content, document_id, sidebar_enabled, $container, $h3, $title, $a_sidebar;

        // Looks at "viewer" and "document_json" and "sidebar_enabled" and makes them match up
        // WARNING: scrolls the document back to page 1.
        refresh_viewer = function() {
          if (document_id) {
            $container.attr('src', 'https://www.documentcloud.org/documents/' + document_id + '?sidebar=' + (sidebar_enabled ? 'true' : 'false'));
            $title.text('');
            //$h3.text('');
          } else {
            $container.attr('src', default_src);
            $title.text($title.attr('data-m-loading'));
            //$h3.text($h3.attr('data-m-loading'));
          }

          $title/*.add($h3)*/.add($container).add($a_sidebar).toggle(!!document_id);
        };

        window.load_documentcloud_document = function(id) {
          if (id == document_id) return;
          document_id = id;
          refresh_viewer();
        };

        $(function() {
          $title = $('title');
          $h3 = $('h3');
          $a_sidebar = $('a.toggle-sidebar');
          $container = $('iframe');

          sidebar_enabled = localStorage.getItem("views.Document.show.sidebar") || false; // TODO make cookie
          default_src = $container.attr('src');

          window.load_documentcloud_document('@document.documentCloudId');

          var refresh_a_sidebar = function() {
            var text = $a_sidebar.attr("data-m-" + (sidebar_enabled ? 'disable' : 'enable'));
            $a_sidebar.text(text);
          };

          $a_sidebar.on('click', function(e) {
            e.preventDefault();

            sidebar_enabled = !sidebar_enabled;

            refresh_a_sidebar();
            refresh_viewer(); // There's no way to enable the sidebar on a running viewer
          });

          refresh_a_sidebar();
        });
      </script>
    </body>
  </html>
}
